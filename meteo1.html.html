<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Météo</title>
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --dark: #212529;
      --light: #f8f9fa;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: var(--light);
      transition: background-image 0.5s ease;
      min-height: 100vh;
      background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80');
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    /* Header */
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
      align-items: center;
    }
    
    .search-box {
      display: flex;
      flex: 1;
      min-width: 250px;
    }
    
    .search-box input {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 8px 0 0 8px;
      font-size: 1rem;
    }
    
    .search-box button {
      padding: 0 1.2rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .search-box button:hover {
      background-color: var(--secondary);
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .action-buttons button {
      padding: 0.8rem;
      border-radius: 8px;
      border: none;
      background-color: var(--dark);
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .action-buttons button:hover {
      opacity: 0.9;
    }
    
    /* Current Weather */
    .current-weather {
      text-align: center;
      margin-bottom: 3rem;
    }
    
    .current-weather .location {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .current-weather .date {
      opacity: 0.8;
      margin-bottom: 1rem;
    }
    
    .current-weather .temp {
      font-size: 5rem;
      font-weight: bold;
      margin: 1rem 0;
    }
    
    .current-weather .weather-icon {
      width: 120px;
      height: 120px;
      margin: 0 auto;
    }
    
    .current-weather .description {
      font-size: 1.5rem;
      text-transform: capitalize;
      margin-bottom: 2rem;
    }
    
    .weather-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .detail-card {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
    
    /* Forecast */
    .forecast-container {
      margin-top: 3rem;
    }
    
    .forecast-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .forecast {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }
    
    .forecast-card {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 10px;
      text-align: center;
      backdrop-filter: blur(5px);
      transition: transform 0.3s;
    }
    
    .forecast-card:hover {
      transform: translateY(-5px);
    }
    
    .forecast-card .day {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .forecast-card .forecast-icon {
      width: 50px;
      height: 50px;
      margin: 0 auto;
    }
    
    .forecast-card .temps {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .forecast-card .max-temp {
      font-weight: bold;
    }
    
    /* Favorites */
    .favorites-container {
      margin-top: 3rem;
    }
    
    .favorites-list {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .favorite-item {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .favorite-item:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Loader */
    .loader {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Error */
    .error-message {
      color: #ff6b6b;
      text-align: center;
      margin: 1rem 0;
      display: none;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .current-weather .temp {
        font-size: 3.5rem;
      }
      
      header {
        flex-direction: column;
      }
      
      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="search-box">
        <input type="text" id="cityInput" placeholder="Entrez une ville...">
        <button id="searchBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
        </button>
      </div>
      <div class="action-buttons">
        <button id="locationBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
          </svg>
          Ma position
        </button>
        <button id="toggleUnitBtn">°C/°F</button>
        <button id="favoriteBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
          </svg>
        </button>
      </div>
    </header>
    
    <div class="loader" id="loader"></div>
    <div class="error-message" id="errorMessage"></div>
    
    <main>
      <section class="current-weather">
        <h1 class="location" id="location">--</h1>
        <p class="date" id="date">--</p>
        <div class="temp" id="temp">--</div>
        <img class="weather-icon" id="weatherIcon" src="" alt="Weather Icon">
        <p class="description" id="description">--</p>
        
        <div class="weather-details">
          <div class="detail-card">
            <p>Humidité</p>
            <p id="humidity">--%</p>
          </div>
          <div class="detail-card">
            <p>Vent</p>
            <p id="wind">-- km/h</p>
          </div>
          <div class="detail-card">
            <p>Ressenti</p>
            <p id="feelsLike">--°</p>
          </div>
          <div class="detail-card">
            <p>Pression</p>
            <p id="pressure">-- hPa</p>
          </div>
        </div>
      </section>
      
      <section class="forecast-container">
        <h2 class="forecast-title">Prévisions sur 5 jours</h2>
        <div class="forecast" id="forecast"></div>
      </section>
      
      <section class="favorites-container">
        <h2 class="forecast-title">Villes favorites</h2>
        <div class="favorites-list" id="favoritesList"></div>
      </section>
    </main>
  </div>

  <script>
    // Configuration
    const API_KEY = 'e947d99e519bde3bada70e2d95ddf476'; // Clé API de test (remplacez par la vôtre)
    let isCelsius = true;
    let currentCity = null;
    let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    
    // Éléments DOM
    const elements = {
      loader: document.getElementById('loader'),
      error: document.getElementById('errorMessage'),
      location: document.getElementById('location'),
      date: document.getElementById('date'),
      temp: document.getElementById('temp'),
      weatherIcon: document.getElementById('weatherIcon'),
      description: document.getElementById('description'),
      humidity: document.getElementById('humidity'),
      wind: document.getElementById('wind'),
      feelsLike: document.getElementById('feelsLike'),
      pressure: document.getElementById('pressure'),
      forecast: document.getElementById('forecast'),
      favoritesList: document.getElementById('favoritesList'),
      cityInput: document.getElementById('cityInput'),
      searchBtn: document.getElementById('searchBtn'),
      locationBtn: document.getElementById('locationBtn'),
      toggleUnitBtn: document.getElementById('toggleUnitBtn'),
      favoriteBtn: document.getElementById('favoriteBtn')
    };
    
    // Événements
    elements.searchBtn.addEventListener('click', searchWeather);
    elements.locationBtn.addEventListener('click', getLocationWeather);
    elements.toggleUnitBtn.addEventListener('click', toggleUnit);
    elements.favoriteBtn.addEventListener('click', toggleFavorite);
    elements.cityInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchWeather();
    });
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      updateFavoritesList();
      // Charger la dernière ville visitée ou Casablanca par défaut
      const lastCity = localStorage.getItem('lastCity') || 'Casablanca';
      getWeather(lastCity);
    });
    
    // Fonctions principales
    async function getWeather(city) {
      try {
        showLoader();
        hideError();
        
        const unit = isCelsius ? 'metric' : 'imperial';
        const response = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?q=${city}&units=${unit}&lang=fr&appid=${API_KEY}`
        );
        
        if (!response.ok) throw new Error('Ville non trouvée');
        
        const data = await response.json();
        currentCity = data.name;
        
        // Mettre à jour l'interface
        updateCurrentWeather(data);
        await getForecast(data.coord.lat, data.coord.lon);
        
        // Sauvegarder la dernière ville
        localStorage.setItem('lastCity', currentCity);
        updateBackground(data.weather[0].main);
        
        // Mettre à jour le bouton favori
        updateFavoriteButton();
        
      } catch (error) {
        showError(error.message);
      } finally {
        hideLoader();
      }
    }
    
    async function getForecast(lat, lon) {
      try {
        const unit = isCelsius ? 'metric' : 'imperial';
        const response = await fetch(
          `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=${unit}&lang=fr&appid=${API_KEY}`
        );
        
        if (!response.ok) throw new Error('Erreur lors de la récupération des prévisions');
        
        const data = await response.json();
        updateForecast(data.list);
        
      } catch (error) {
        console.error('Forecast Error:', error);
      }
    }
    
    function updateCurrentWeather(data) {
      elements.location.textContent = data.name + ', ' + data.sys.country;
      
      const now = new Date();
      elements.date.textContent = now.toLocaleDateString('fr-FR', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      elements.temp.textContent = Math.round(data.main.temp) + '°' + (isCelsius ? 'C' : 'F');
      elements.weatherIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
      elements.weatherIcon.alt = data.weather[0].description;
      elements.description.textContent = data.weather[0].description;
      elements.humidity.textContent = data.main.humidity + '%';
      elements.wind.textContent = Math.round(data.wind.speed * 3.6) + ' km/h';
      elements.feelsLike.textContent = Math.round(data.main.feels_like) + '°';
      elements.pressure.textContent = data.main.pressure + ' hPa';
    }
    
    function updateForecast(forecastData) {
      elements.forecast.innerHTML = '';
      
      // Grouper par jour (on prend une prévision par jour vers midi)
      const dailyForecasts = {};
      forecastData.forEach(item => {
        const date = item.dt_txt.split(' ')[0];
        const hour = new Date(item.dt * 1000).getHours();
        
        // On prend la prévision la plus proche de midi (12h)
        if (hour >= 11 && hour <= 13 && !dailyForecasts[date]) {
          dailyForecasts[date] = item;
        }
      });
      
      // Afficher les 5 prochains jours
      Object.keys(dailyForecasts).slice(0, 5).forEach(date => {
        const forecast = dailyForecasts[date];
        const dayName = new Date(date).toLocaleDateString('fr-FR', { weekday: 'long' });
        
        const forecastCard = document.createElement('div');
        forecastCard.className = 'forecast-card';
        forecastCard.innerHTML = `
          <div class="day">${capitalizeFirstLetter(dayName)}</div>
          <img class="forecast-icon" src="https://openweathermap.org/img/wn/${forecast.weather[0].icon}.png" alt="${forecast.weather[0].description}">
          <div class="temps">
            <span class="max-temp">${Math.round(forecast.main.temp_max)}°</span>
            <span class="min-temp">${Math.round(forecast.main.temp_min)}°</span>
          </div>
          <p>${forecast.weather[0].description}</p>
        `;
        
        elements.forecast.appendChild(forecastCard);
      });
    }
    
    function updateBackground(weatherCondition) {
      const backgrounds = {
        Clear: 'linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url("https://images.unsplash.com/photo-1494548162494-384bba4ab999?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80")',
        Clouds: 'linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url("https://images.unsplash.com/photo-1483728642387-6c3bdd6c93e5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80")',
        Rain: 'linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url("https://images.unsplash.com/photo-1438449805896-28a666819a20?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80")',
        Snow: 'linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url("https://images.unsplash.com/photo-1491002052546-bf38f186af56?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80")',
        Thunderstorm: 'linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url("https://images.unsplash.com/photo-1492011221367-f47e3ccd77a0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80")'
      };
      
      const newBackground = backgrounds[weatherCondition] || 
        'linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url("https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80")';
      
      document.body.style.backgroundImage = newBackground;
    }
    
    // Fonctions utilitaires
    function searchWeather() {
      const city = elements.cityInput.value.trim();
      if (!city) {
        showError('Veuillez entrer une ville');
        return;
      }
      getWeather(city);
    }
    
    function getLocationWeather() {
      if (!navigator.geolocation) {
        showError('La géolocalisation n\'est pas supportée par votre navigateur');
        return;
      }
      
      showLoader();
      navigator.geolocation.getCurrentPosition(
        position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          
          fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=${isCelsius ? 'metric' : 'imperial'}&lang=fr&appid=${API_KEY}`)
            .then(res => res.json())
            .then(data => {
              currentCity = data.name;
              elements.cityInput.value = currentCity;
              updateCurrentWeather(data);
              getForecast(lat, lon);
              updateBackground(data.weather[0].main);
              updateFavoriteButton();
            })
            .catch(error => {
              showError('Erreur lors de la récupération des données');
              console.error(error);
            })
            .finally(() => {
              hideLoader();
            });
        },
        error => {
          showError('Impossible d\'obtenir votre position. Vérifiez les permissions.');
          hideLoader();
        }
      );
    }
    
    function toggleUnit() {
      isCelsius = !isCelsius;
      elements.toggleUnitBtn.textContent = isCelsius ? '°C/°F' : '°F/°C';
      
      if (currentCity) {
        getWeather(currentCity);
      }
    }
    
    function toggleFavorite() {
      if (!currentCity) return;
      
      const index = favorites.indexOf(currentCity);
      if (index === -1) {
        favorites.push(currentCity);
      } else {
        favorites.splice(index, 1);
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateFavoriteButton();
      updateFavoritesList();
    }
    
    function updateFavoriteButton() {
      if (!currentCity) return;
      
      const isFavorite = favorites.includes(currentCity);
      elements.favoriteBtn.innerHTML = isFavorite ? 
        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="red" viewBox="0 0 16 16"><path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z"/></svg>' : 
        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/></svg>';
    }
    
    function updateFavoritesList() {
      elements.favoritesList.innerHTML = '';
      
      favorites.forEach(city => {
        const favoriteItem = document.createElement('div');
        favoriteItem.className = 'favorite-item';
        favoriteItem.textContent = city;
        favoriteItem.addEventListener('click', () => {
          elements.cityInput.value = city;
          getWeather(city);
        });
        
        elements.favoritesList.appendChild(favoriteItem);
      });
    }
    
    function showLoader() {
      elements.loader.style.display = 'block';
    }
    
    function hideLoader() {
      elements.loader.style.display = 'none';
    }
    
    function showError(message) {
      elements.error.textContent = message;
      elements.error.style.display = 'block';
    }
    
    function hideError() {
      elements.error.style.display = 'none';
    }
    
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
  </script>
</body>
</html>